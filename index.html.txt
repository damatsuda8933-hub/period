<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç»æœŸè®°å½•</title>
<style>
  :root{
    --bg:#e9f7ef; --card:#ffffff; --ink:#1b4332; --muted:#5c7a6b; --line:#cce3d5;
    --pink:#ff8ba7;   /* ç»æœŸ */
    --mint:#ccffd8;   /* åµæ³¡æœŸ */
    --blue:#8be9ff;   /* æ’åµé«˜å³°ï¼ˆ3å¤©ï¼‰*/
    --gold:#ffeaa7;   /* é»„ä½“æœŸ */
    --today:#1b4332;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Noto Sans SC",sans-serif}
  .wrap{max-width:780px;margin:24px auto;padding:0 16px 36px}
  h1{font-size:20px;margin:16px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select,textarea{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:var(--card)}
  button.primary{background:#2d6a4f;color:#fff;border-color:#2d6a4f}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
  .legend{display:flex;gap:16px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
  .sw{display:inline-block;width:14px;height:14px;border-radius:3px;vertical-align:-2px;margin-right:6px}
  .sw.p{background:var(--pink)} .sw.f{background:var(--mint)} .sw.o{background:var(--blue)} .sw.l{background:var(--gold)}
  .cal{width:100%;border-collapse:collapse;margin-top:8px}
  .cal th,.cal td{border:1px solid var(--line);width:14.285%;vertical-align:top;text-align:center}
  .cal th{background:#f2fbf6;padding:8px 0;font-weight:600}
  .cal td{height:90px;position:relative;background:#fff;cursor:pointer}
  .cal td.p{background:var(--pink)}
  .cal td.f{background:var(--mint)}
  .cal td.o{background:var(--blue)}
  .cal td.l{background:var(--gold)}
  .cal td .d{position:absolute;top:6px;left:6px;font-size:12px;color:#2c3e50}
  .cal td.today{outline:2px dashed var(--today);outline-offset:-4px}
  .note{position:absolute;bottom:6px;left:6px;right:6px;display:flex;justify-content:space-between;gap:6px;align-items:flex-end}
  .icons{font-size:14px;display:flex;gap:6px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .toolbar .nav button{padding:6px 10px}
  .muted{color:var(--muted);font-size:14px}
  dialog{border:none;border-radius:12px;padding:0;max-width:380px;width:92%}
  .dlg{padding:14px}
  .dlg h3{margin:0 0 8px 0;font-size:16px}
  .moon-row{display:flex;gap:6px;flex-wrap:wrap}
  .moon{font-size:22px;line-height:40px;width:40px;height:40px;display:grid;place-items:center;border:1px solid var(--line);border-radius:8px;cursor:pointer;background:#fff}
  .moon.sel{outline:2px solid #2d6a4f}
  .footer{margin-top:2px;padding:10px;background:#f6fcf9;border-top:1px solid var(--line);border-bottom-left-radius:12px;border-bottom-right-radius:12px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#eef6f0;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .thumb{width:100%;max-height:200px;object-fit:contain;border:1px solid var(--line);border-radius:8px;background:#fff}
  .settings .row{gap:6px}
  .danger{background:#8c2f39;color:#fff;border-color:#8c2f39}
  /* é”å± */
  #lock::backdrop{background:rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="wrap" id="app">
  <h1>ç»æœŸè®°å½•</h1>

  <!-- å‘¨æœŸå½•å…¥ -->
  <div class="card">
    <div class="row">
      <label>æœ¬æ¬¡æœˆç»ç¬¬ 1 å¤© <input type="date" id="startDate"></label>
      <label>ç»æœŸå¤©æ•° <input type="number" id="periodLength" value="5" min="1" max="12" style="width:90px"></label>
      <label>å¹³å‡å‘¨æœŸ <input type="number" id="cycleLength" value="28" min="18" max="60" style="width:90px"></label>
      <button class="primary" id="saveCycle">ä¿å­˜/æ›´æ–°æ­¤å‘¨æœŸ</button>
      <button id="setDefaults" title="å°†å½“å‰æ•°å€¼è®¾ä¸ºé»˜è®¤">è®¾ä¸ºé»˜è®¤</button>
    </div>
    <div class="muted" style="margin-top:6px">æ”¯æŒé•¿æœŸä¿å­˜å¤šä¸ªå‘¨æœŸï¼›é¢„æµ‹ä½¿ç”¨æœ€è¿‘ 6 æ¬¡ä¸­ä½æ•°ï¼Œä»…ä¾›å‚è€ƒã€‚</div>
  </div>

  <!-- æ—¥å†å·¥å…·æ  -->
  <div class="toolbar">
    <div class="nav">
      <button id="prevM">â—€ ä¸Šæœˆ</button>
      <button id="today">ä»Šæœˆ</button>
      <button id="nextM">ä¸‹æœˆ â–¶</button>
    </div>
    <div class="muted" id="monthLabel"></div>
  </div>

  <!-- å›¾ä¾‹ -->
  <div class="legend card">
    <div><span class="sw p"></span>ç»æœŸ</div>
    <div><span class="sw f"></span>åµæ³¡æœŸ</div>
    <div><span class="sw o"></span>æ’åµé«˜å³°ï¼ˆ3 å¤©ï¼‰</div>
    <div><span class="sw l"></span>é»„ä½“æœŸ</div>
    <div>å¿ƒæƒ…ï¼šä»»æ„ emojiï¼›æœˆç›¸ï¼šğŸŒ‘ / ğŸŒ’ / ğŸŒ— / ğŸŒ•ã€€ï¼ˆåªæ˜¾ç¤ºå›¾æ ‡ï¼‰</div>
    <div>ğŸ“·ï¼šæœ‰å›¾ç‰‡ã€€ğŸ’¬ï¼šæœ‰è‚Œè‚¤è®°å½•</div>
  </div>

  <!-- æ—¥å† -->
  <div class="card" id="calendarCard">
    <table class="cal" id="cal"></table>
  </div>

  <!-- æ‘˜è¦ -->
  <div class="card" id="summary"></div>

  <!-- è®¾ç½®/å¤‡ä»½ -->
  <div class="card settings">
    <div class="row" style="flex-wrap:wrap">
      <button id="exportBtn">å¯¼å‡ºå¤‡ä»½</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="importBtn">å¯¼å…¥å¤‡ä»½</button>
      <button id="icsBtn">å¯¼å‡º .icsï¼ˆä¸‹æ¬¡é¢„æµ‹ï¼‰</button>
      <button id="setPIN">è®¾ç½®/ä¿®æ”¹ PIN</button>
      <button id="clearPIN">å…³é—­ PIN</button>
      <button class="danger" id="wipeAll">ä¸€é”®æ¸…ç©º</button>
    </div>
    <div class="muted" style="margin-top:6px">å›¾ç‰‡ä¸å¤§æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆIndexedDBï¼‰ï¼›å¯¼å‡ºå¤‡ä»½ä¼šåŒ…å«å›¾ç‰‡ã€‚</div>
  </div>
</div>

<!-- ç¼–è¾‘å¯¹è¯æ¡† -->
<dialog id="editor">
  <div class="dlg">
    <h3 id="dlgTitle">ç¼–è¾‘</h3>
    <div class="row" style="margin:6px 0 6px 0">
      <label>å¿ƒæƒ… <input id="moodInput" placeholder="ğŸ™‚ / ğŸ˜´ / ğŸ˜  ..." style="width:140px"></label>
      <label>é˜¶æ®µè¦†ç›–
        <select id="phaseOverride">
          <option value="">è‡ªåŠ¨</option>
          <option value="p">ç»æœŸ</option>
          <option value="f">åµæ³¡æœŸ</option>
          <option value="o">æ’åµé«˜å³°</option>
          <option value="l">é»„ä½“æœŸ</option>
        </select>
      </label>
    </div>
    <div>
      <div class="muted" style="margin-bottom:4px">æœˆç›¸</div>
      <div class="moon-row" id="moonRow">
        <div class="moon" data-v="1" title="ä½">ğŸŒ‘</div>
        <div class="moon" data-v="2" title="è¾ƒä½">ğŸŒ’</div>
        <div class="moon" data-v="3" title="ä¸­">ğŸŒ—</div>
        <div class="moon" data-v="4" title="é«˜">ğŸŒ•</div>
      </div>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:4px">è‚Œè‚¤è®°å½•ï¼ˆæ–‡æœ¬ï¼‰</div>
      <textarea id="skinText" rows="3" placeholder="å¦‚ï¼šä»Šæ—¥æ³›çº¢å‡è½»ï¼Œå±éšœæ„Ÿè¾ƒç¨³â€¦" style="width:100%"></textarea>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:4px">è‚Œè‚¤ç…§ç‰‡ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨å‹ç¼©ï¼‰</div>
      <input type="file" id="skinImg" accept="image/*">
      <img id="preview" class="thumb" style="display:none;margin-top:8px">
    </div>
  </div>
  <div class="footer">
    <div class="row" style="justify-content:space-between">
      <button id="delImg">åˆ é™¤å›¾ç‰‡</button>
      <div>
        <button id="delNote">æ¸…é™¤è®°å½•</button>
        <button class="primary" id="saveNote">ä¿å­˜</button>
      </div>
    </div>
  </div>
</dialog>

<!-- é”å± -->
<dialog id="lock">
  <div class="dlg">
    <h3 style="margin-bottom:10px">å·²åŠ é”</h3>
    <div class="row">
      <input type="password" id="pinInput" inputmode="numeric" placeholder="è¾“å…¥ PINï¼ˆ4â€“12ä½ï¼‰" style="width:220px">
      <button class="primary" id="unlockBtn">è§£é”</button>
    </div>
    <div id="lockMsg" class="muted" style="margin-top:6px"></div>
  </div>
</dialog>

<script>
/* ========= å°å·¥å…·ï¼šæœ¬åœ°æ—¥æœŸé”®ï¼Œé¿å…æ—¶åŒºåå·® ========= */
const pad = n => String(n).padStart(2,'0');
const dateKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const fromKey = k => { const [y,m,d]=k.split('-').map(Number); return new Date(y, m-1, d, 12); }; // ç”¨ä¸­åˆé¿å…DST
const addDays = (d,n) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+n, 12);
const diffDays = (a,b) => Math.round((+new Date(a.getFullYear(),a.getMonth(),a.getDate(),12) - +new Date(b.getFullYear(),b.getMonth(),b.getDate(),12))/86400000);
const isBetween = (d,a,b) => diffDays(d,a) >= 0 && diffDays(d,b) <= 0;
const $ = s => document.querySelector(s);

/* ========= æ•°æ®ï¼šlocalStorageï¼ˆè½»ï¼‰ + IndexedDBï¼ˆå›¾åƒï¼‰ ========= */
const DB_KEY = 'periodDB_v3';
const loadDB = () => {
  try{ return JSON.parse(localStorage.getItem(DB_KEY)) || {
    profile:{periodLength:5, cycleLength:28},
    cycles:[], // {start:"YYYY-MM-DD", periodLength, cycleLength}
    notes:{}  // "YYYY-MM-DD": { mood:"ğŸ™‚", moon:1..4, skinText:"", phase?:'p'|'f'|'o'|'l', hasImg?:true }
  }; }catch(e){ return {profile:{periodLength:5,cycleLength:28},cycles:[],notes:{}}; }
};
const saveDB = db => localStorage.setItem(DB_KEY, JSON.stringify(db));
let DB = loadDB();

/* ---- IndexedDB å°è£…ï¼ˆå­˜ dataURLï¼Œä¾¿äºå¤‡ä»½å¯¼å‡ºï¼‰ ---- */
const IDB_NAME='periodMedia_v1', STORE='images';
function idbOpen(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(IDB_NAME,1);
    r.onupgradeneeded = ()=> r.result.createObjectStore(STORE,{keyPath:'date'});
    r.onsuccess = ()=> res(r.result);
    r.onerror = ()=> rej(r.error);
  });
}
async function idbGet(date){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE);
  const g=st.get(date); g.onsuccess=()=>res(g.result||null); g.onerror=()=>rej(g.error);
});}
async function idbSet(date, dataURL){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE);
  const p=st.put({date,dataURL,updated:Date.now()}); p.onsuccess=()=>res(); p.onerror=()=>rej(p.error);
});}
async function idbDel(date){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE);
  const d=st.delete(date); d.onsuccess=()=>res(); d.onerror=()=>rej(d.error);
});}
async function idbAll(){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE);
  const out={}; st.openCursor().onsuccess=e=>{ const c=e.target.result; if(c){ out[c.key]=c.value.dataURL; c.continue(); }else res(out); };
  tx.onerror=()=>rej(tx.error);
});}
async function idbClear(){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE);
  const c=st.clear(); c.onsuccess=()=>res(); c.onerror=()=>rej(c.error);
});}

/* ========= è§†å›¾çŠ¶æ€ ========= */
let view = (()=>{
  const t=new Date(); return { y:t.getFullYear(), m:t.getMonth() }; // 0-11
})();

/* ========= å‘¨æœŸ/é˜¶æ®µè®¡ç®— ========= */
function median(arr){
  if(!arr.length) return null;
  const a=[...arr].sort((x,y)=>x-y);
  const mid=Math.floor(a.length/2);
  return a.length%2? a[mid] : Math.round((a[mid-1]+a[mid])/2);
}
function recentMedianCycle(len=6){
  const list=[...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start)).slice(-len);
  const cs=list.map(x=>Number(x.cycleLength)||28), ps=list.map(x=>Number(x.periodLength)||5);
  return {cMed: median(cs)||28, pMed: median(ps)||5};
}

function getCycleForDate(date){
  if(DB.cycles.length===0) return null;
  const list = [...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start));
  const dKey = dateKey(date);
  let base = null;
  for(const c of list){ if(c.start <= dKey) base = c; else break; }
  if(!base) return null;
  const cLen = Number(base.cycleLength) || Number(DB.profile.cycleLength) || 28;
  let s = fromKey(base.start);
  if(diffDays(date, s) >= cLen){
    const k = Math.floor(diffDays(date, s)/cLen);
    s = addDays(s, k*cLen);
  }
  const pLen = Number(base.periodLength) || Number(DB.profile.periodLength) || 5;
  return { start:s, pLen, cLen };
}

function phaseWindows(start, pLen, cLen){
  const mStart = start;
  const mEnd   = addDays(start, pLen-1);
  const oStart = addDays(start, cLen-14-1);  // é«˜å³° 3 å¤©ï¼š[-1, +1]
  const oEnd   = addDays(start, cLen-14+1);
  const lStart = addDays(start, cLen-14+2);
  const lEnd   = addDays(start, cLen-1);
  const fStart = addDays(mEnd, 1);
  const fEnd   = addDays(oStart, -1);
  return { mStart,mEnd,fStart,fEnd,oStart,oEnd,lStart,lEnd };
}

function getPhaseForDate(date){
  const key = dateKey(date);
  const override = DB.notes[key]?.phase;
  if(override) return override; // æ‰‹åŠ¨è¦†ç›–ä¼˜å…ˆ
  const cy = getCycleForDate(date);
  if(!cy) return '';
  const W = phaseWindows(cy.start, cy.pLen, cy.cLen);
  if(isBetween(date, W.mStart, W.mEnd)) return 'p';
  if(isBetween(date, W.fStart, W.fEnd)) return 'f';
  if(isBetween(date, W.oStart, W.oEnd)) return 'o';
  if(isBetween(date, W.lStart, W.lEnd)) return 'l';
  return '';
}

/* ========= çš®è‚¤æ¢å¤å‹å¥½åº¦ï¼ˆè‡ªåŠ¨æ ‡ç­¾ï¼‰ ========= */
function skinFavorLabel(phase){
  switch(phase){
    case 'f': return 'åˆ©äºæ¢å¤';
    case 'o': return 'å¹³è¡¡è§‚å¯Ÿ';
    case 'l': return 'æ˜“æ³¢åŠ¨';
    case 'p': return 'æ•æ„Ÿ';
    default:  return 'â€”';
  }
}

/* ========= æ¸²æŸ“ï¼šæ—¥å† + æ‘˜è¦ ========= */
const cal = $('#cal'), monthLabel = $('#monthLabel');
async function renderCalendar(){
  const y=view.y, m=view.m;
  const first = new Date(y, m, 1, 12);
  const last  = new Date(y, m+1, 0, 12);
  monthLabel.textContent = `${y} å¹´ ${m+1} æœˆ`;

  cal.innerHTML = '';
  const header = document.createElement('tr');
  'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').forEach(w=>{ const th=document.createElement('th'); th.textContent=w; header.appendChild(th); });
  cal.appendChild(header);

  let tr = document.createElement('tr');
  for(let i=0;i<first.getDay();i++){ tr.appendChild(document.createElement('td')); }

  for(let d=1; d<=last.getDate(); d++){
    const cur = new Date(y, m, d, 12);
    const k   = dateKey(cur);
    const td  = document.createElement('td');

    const dd = document.createElement('div'); dd.className='d'; dd.textContent=d; td.appendChild(dd);

    const ph = getPhaseForDate(cur);
    if(ph) td.classList.add(ph);

    if(k === dateKey(new Date())) td.classList.add('today');

    const box = document.createElement('div'); box.className='note';
    const mood = DB.notes[k]?.mood || '';
    const moonLevel = DB.notes[k]?.moon || 0;
    const moonIcon = ['', 'ğŸŒ‘','ğŸŒ’','ğŸŒ—','ğŸŒ•'][moonLevel] || '';
    const left = document.createElement('span'); left.textContent = mood;
    const right = document.createElement('span'); right.textContent = moonIcon;
    box.appendChild(left); box.appendChild(right);

    const icons = document.createElement('div'); icons.className='icons';
    if(DB.notes[k]?.skinText) icons.insertAdjacentText('beforeend','ğŸ’¬');
    if(DB.notes[k]?.hasImg)   icons.insertAdjacentText('beforeend','ğŸ“·');
    box.appendChild(icons);

    td.appendChild(box);
    td.dataset.date = k;
    td.addEventListener('click', ()=> openEditor(k, ph));

    tr.appendChild(td);
    if(cur.getDay()===6 || d===last.getDate()){ cal.appendChild(tr); tr=document.createElement('tr'); }
  }

  renderSummary();
}

function nextPredictedStart(){
  if(!DB.cycles.length) return null;
  const {cMed, pMed} = recentMedianCycle();
  const list=[...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start));
  let t = fromKey(list.at(-1).start);
  const today = new Date();
  while(diffDays(t, today) <= 0){ t = addDays(t, cMed); }
  return {start:t, cLen:cMed, pLen:pMed};
}

function renderSummary(){
  const mid = new Date(view.y, view.m, 15, 12);
  const s = $('#summary');

  if(DB.cycles.length===0){
    s.innerHTML = `<b>æ‘˜è¦</b><br><span class="muted">å°šæ— å‘¨æœŸè®°å½•ï¼Œè¯·å…ˆä¸Šæ–¹ä¿å­˜ä¸€æ¬¡â€œæœ¬æ¬¡æœˆç»ç¬¬ 1 å¤©â€ã€‚</span>`;
    return;
  }
  const cy = getCycleForDate(mid);
  if(!cy){
    s.innerHTML = `<b>æ‘˜è¦</b><br><span class="muted">æ­¤æœˆä»½æ—©äºé¦–ä¸ªè®°å½•ï¼Œå‘åç¿»æœˆæˆ–æ·»åŠ æ›´æ—©è®°å½•ã€‚</span>`;
    return;
  }
  const {mStart,mEnd,fStart,fEnd,oStart,oEnd,lStart,lEnd} = phaseWindows(cy.start, cy.pLen, cy.cLen);

  const np = nextPredictedStart();
  const nextPred = np ? dateKey(np.start) : 'â€”';

  const today = new Date();
  const todayPhase = getPhaseForDate(today);
  const todayTip = skinFavorLabel(todayPhase);

  // æœ¬æœˆå¿ƒæƒ…/æœˆç›¸åˆ†å¸ƒ
  const last  = new Date(view.y, view.m+1, 0, 12);
  let moodCnt = {}, moonCnt=[0,0,0,0,0];
  for(let d=1; d<=last.getDate(); d++){
    const k = dateKey(new Date(view.y, view.m, d, 12));
    const note = DB.notes[k];
    if(note){
      if(note.mood) moodCnt[note.mood]=(moodCnt[note.mood]||0)+1;
      if(note.moon) moonCnt[note.moon]++;
    }
  }
  const topMood = Object.entries(moodCnt).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'â€”';
  const moonIcons=['','ğŸŒ‘','ğŸŒ’','ğŸŒ—','ğŸŒ•'];
  const moonDist = moonCnt.slice(1).map((n,i)=>`${moonIcons[i+1]}Ã—${n}`).join('ï¼Œ') || 'â€”';

  s.innerHTML = `
    <b>æ‘˜è¦ï¼ˆä»¥æœ¬æœˆä¸­æ—¬æ‰€åœ¨çš„å‘¨æœŸä¸ºåŸºå‡†ï¼‰</b><br>
    ç»æœŸï¼š${dateKey(mStart)} â€” ${dateKey(mEnd)}ï¼ˆ${cy.pLen} å¤©ï¼‰<br>
    åµæ³¡æœŸï¼š${dateKey(fStart)} â€” ${dateKey(fEnd)}ï¼ˆåˆ©äºæ¢å¤ï¼‰<br>
    æ’åµé«˜å³°ï¼š${dateKey(oStart)} â€” ${dateKey(oEnd)}ï¼ˆå¹³è¡¡è§‚å¯Ÿï¼‰<br>
    é»„ä½“æœŸï¼š${dateKey(lStart)} â€” ${dateKey(lEnd)}ï¼ˆæ˜“æ³¢åŠ¨ï¼‰<br>
    æœ€è¿‘è®°å½•æ¨ç®—çš„ä¸‹ä¸€æ¬¡æœˆç»ï¼š<span class="kbd">${nextPred}</span><br>
    ä»Šæ—¥çš®è‚¤å‹å¥½åº¦ï¼š<span class="kbd">${todayTip}</span><br>
    æœ¬æœˆå¿ƒæƒ…æœ€å¤šï¼š${topMood}ï¼›æœˆç›¸åˆ†å¸ƒï¼š${moonDist}
  `;
}

/* ========= ç¼–è¾‘å™¨ ========= */
const editor = $('#editor');
let editKey = null, pendingImg = null;
async function openEditor(k, phase){
  editKey = k; pendingImg = null;
  $('#dlgTitle').textContent = `ç¼–è¾‘ ${k}ï¼ˆ${skinFavorLabel(phase)}ï¼‰`;
  $('#moodInput').value = DB.notes[k]?.mood || '';
  $('#skinText').value = DB.notes[k]?.skinText || '';
  $('#phaseOverride').value = DB.notes[k]?.phase || '';

  const level = DB.notes[k]?.moon || 0;
  document.querySelectorAll('.moon').forEach(el=>{
    el.classList.toggle('sel', Number(el.dataset.v)===level);
    el.onclick = ()=> {
      document.querySelectorAll('.moon').forEach(x=>x.classList.remove('sel'));
      el.classList.add('sel');
      editor.dataset.moon = el.dataset.v;
    };
  });
  editor.dataset.moon = String(level||0);

  // é¢„è§ˆå›¾ç‰‡ï¼ˆä»IndexedDBï¼‰
  const prev = $('#preview');
  const imgRec = await idbGet(k);
  if(imgRec){ prev.src = imgRec.dataURL; prev.style.display='block'; }
  else { prev.removeAttribute('src'); prev.style.display='none'; }

  $('#skinImg').value = '';
  editor.showModal();
}

/* å›¾ç‰‡å‹ç¼©åˆ° ~1280 å®½/é«˜ï¼ŒJPEG 82% */
function compressImage(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const max = 1280;
        let {width:w, height:h} = img;
        const r = Math.min(1, max/Math.max(w,h));
        const cw = Math.round(w*r), ch = Math.round(h*r);
        const cv = document.createElement('canvas'); cv.width=cw; cv.height=ch;
        const ctx = cv.getContext('2d');
        ctx.drawImage(img,0,0,cw,ch);
        let url;
        try{ url = cv.toDataURL('image/jpeg',0.82); }
        catch{ url = cv.toDataURL('image/png'); }
        resolve(url);
      };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

$('#skinImg').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const url = await compressImage(file);
  pendingImg = url;
  const prev=$('#preview'); prev.src=url; prev.style.display='block';
});
$('#delImg').onclick = async ()=>{
  if(!editKey) return;
  await idbDel(editKey); pendingImg=null;
  if(DB.notes[editKey]) DB.notes[editKey].hasImg=false;
  saveDB(DB);
  const prev=$('#preview'); prev.removeAttribute('src'); prev.style.display='none';
};

$('#saveNote').onclick = async ()=>{
  if(!editKey){ editor.close(); return; }
  const mood = $('#moodInput').value.trim();
  const moon = Number(editor.dataset.moon||0);
  const skinText = $('#skinText').value.trim();
  const phase = $('#phaseOverride').value;

  DB.notes[editKey] = { ...(DB.notes[editKey]||{}), mood, moon, skinText };
  if(phase) DB.notes[editKey].phase = phase; else delete DB.notes[editKey].phase;

  if(pendingImg){ await idbSet(editKey, pendingImg); DB.notes[editKey].hasImg = true; }

  // è‹¥å…¨ç©ºåˆ™åˆ é™¤
  const n = DB.notes[editKey];
  if(!n.mood && !n.moon && !n.skinText && !n.hasImg && !n.phase) delete DB.notes[editKey];

  saveDB(DB);
  editor.close(); renderCalendar();
};
$('#delNote').onclick = async ()=>{
  if(editKey && DB.notes[editKey]) delete DB.notes[editKey];
  await idbDel(editKey);
  saveDB(DB); editor.close(); renderCalendar();
};

/* ========= äº¤äº’ï¼šä¿å­˜å‘¨æœŸ / è®¾ä¸ºé»˜è®¤ / å¯¼èˆª ========= */
$('#saveCycle').onclick = ()=>{
  const s = $('#startDate').value;
  if(!s) return alert('è¯·é€‰æ‹©â€œæœ¬æ¬¡æœˆç»ç¬¬ 1 å¤©â€ã€‚');
  const p = Number($('#periodLength').value)||5;
  const c = Number($('#cycleLength').value)||28;
  const i = DB.cycles.findIndex(x=>x.start===s);
  if(i>=0) DB.cycles[i] = {start:s, periodLength:p, cycleLength:c};
  else DB.cycles.push({start:s, periodLength:p, cycleLength:c});
  const d = fromKey(s); view.y=d.getFullYear(); view.m=d.getMonth();
  saveDB(DB); renderCalendar();
};
$('#setDefaults').onclick = ()=>{
  DB.profile.periodLength = Number($('#periodLength').value)||5;
  DB.profile.cycleLength  = Number($('#cycleLength').value)||28;
  saveDB(DB); alert('å·²è®¾ä¸ºé»˜è®¤ã€‚');
};
$('#prevM').onclick = ()=>{ view.m--; if(view.m<0){view.m=11;view.y--;} renderCalendar(); };
$('#nextM').onclick = ()=>{ view.m++; if(view.m>11){view.m=0;view.y++;} renderCalendar(); };
$('#today').onclick  = ()=>{ const t=new Date(); view.y=t.getFullYear(); view.m=t.getMonth(); renderCalendar(); };

/* ========= å¤‡ä»½ / å¯¼å…¥ / .ics / æ¸…ç©º ========= */
$('#exportBtn').onclick = async ()=>{
  const images = await idbAll();
  const payload = {db:DB, images};
  const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'period-backup.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('#importBtn').onclick = ()=> $('#importFile').click();
$('#importFile').onchange = e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = async ()=>{
    try{
      const obj = JSON.parse(r.result);
      if(obj.db) DB = obj.db; else DB = obj; // å…¼å®¹æ—§æ ¼å¼
      saveDB(DB);
      if(obj.images){
        for(const [k,v] of Object.entries(obj.images)){ await idbSet(k, v); if(DB.notes[k]) DB.notes[k].hasImg=true; }
        saveDB(DB);
      }
      location.reload();
    }catch{ alert('æ–‡ä»¶æ ¼å¼ä¸å¯¹'); }
  };
  r.readAsText(f);
};

function icsDate(key){ const [y,m,d]=key.split('-').map(Number); return `${y}${pad(m)}${pad(d)}`; }
$('#icsBtn').onclick = ()=>{
  const np = nextPredictedStart();
  if(!np){ alert('è¿˜æ²¡æœ‰è¶³å¤Ÿæ•°æ®ç”¨äºé¢„æµ‹ã€‚'); return; }
  const startKey = dateKey(np.start);
  const periodEndKey = dateKey(addDays(np.start, np.pLen)); // ics DTEND ä¸ºæ¬¡æ—¥ï¼ˆæ’é™¤å¼ï¼‰
  const ovCenter = addDays(np.start, -14);
  const ovStartKey = dateKey(addDays(ovCenter, -1));
  const ovEndKeyEx = dateKey(addDays(ovCenter, 2));
  const uid = ()=>'xxxxxx'.replace(/x/g,()=>Math.floor(Math.random()*16).toString(16))+Date.now();
  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//period-local//cn//',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
      `UID:${uid()}`,
      'SUMMARY:ç»æœŸï¼ˆé¢„æµ‹ï¼‰',
      `DTSTART;VALUE=DATE:${icsDate(startKey)}`,
      `DTEND;VALUE=DATE:${icsDate(periodEndKey)}`,
    'END:VEVENT',
    'BEGIN:VEVENT',
      `UID:${uid()}`,
      'SUMMARY:æ’åµé«˜å³°ï¼ˆé¢„æµ‹ï¼‰',
      `DTSTART;VALUE=DATE:${icsDate(ovStartKey)}`,
      `DTEND;VALUE=DATE:${icsDate(ovEndKeyEx)}`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
  const blob = new Blob([ics], {type:'text/calendar'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'period-prediction.ics'; a.click(); URL.revokeObjectURL(a.href);
};

$('#wipeAll').onclick = async ()=>{
  if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  localStorage.removeItem(DB_KEY);
  await idbClear();
  location.reload();
};

/* ========= PIN åŠ é” ========= */
async function sha256(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const b = Array.from(new Uint8Array(buf)).map(x=>x.toString(16).padStart(2,'0')).join('');
  return b;
}
function getPIN(){ try{ return JSON.parse(localStorage.getItem('periodPIN')||'null'); }catch{ return null; } }
function setPINHash(hash){ localStorage.setItem('periodPIN', JSON.stringify({hash})); }
function clearPIN(){ localStorage.removeItem('periodPIN'); }

$('#setPIN').onclick = async ()=>{
  const p = prompt('è®¾ç½®/ä¿®æ”¹ PINï¼ˆ4â€“12ä½ï¼Œç•™ç©ºå–æ¶ˆï¼‰'); if(!p) return;
  if(p.length<4 || p.length>12) return alert('é•¿åº¦åº”åœ¨ 4â€“12 ä½ã€‚');
  const h = await sha256(p); setPINHash(h); alert('å·²è®¾ç½® PINã€‚');
};
$('#clearPIN').onclick = ()=>{ clearPIN(); alert('å·²å…³é—­ PINã€‚'); };

async function checkLock(){
  const pin = getPIN(); if(!pin) return;
  const lock = $('#lock'); lock.showModal();
  $('#pinInput').value=''; $('#lockMsg').textContent='';
  $('#unlockBtn').onclick = async ()=>{
    const h = await sha256($('#pinInput').value||'');
    if(h===pin.hash){ lock.close(); }
    else{ $('#lockMsg').textContent='PIN é”™è¯¯'; }
  };
}

/* ========= PWAï¼ˆæœ¬åœ°æ–‡ä»¶æ¨¡å¼å¯èƒ½æ— æ³•æ³¨å†Œ SWï¼Œå¿½ç•¥å¤±è´¥å³å¯ï¼‰ ========= */
(function setupPWA(){
  try{
    // ç”Ÿæˆä¸€ä¸ªç®€å•å›¾æ ‡
    const cv=document.createElement('canvas'); cv.width=192; cv.height=192;
    const ctx=cv.getContext('2d'); ctx.fillStyle='#e9f7ef'; ctx.fillRect(0,0,192,192);
    ctx.fillStyle='#2d6a4f'; ctx.beginPath(); ctx.arc(96,96,58,0,Math.PI*2); ctx.fill();
    const icon=cv.toDataURL('image/png');
    const manifest={
      name:'ç»æœŸè®°å½•', short_name:'ç»æœŸè®°å½•', start_url:'./', display:'standalone',
      background_color:'#e9f7ef', theme_color:'#2d6a4f',
      icons:[{src:icon,sizes:'192x192',type:'image/png'}]
    };
    const mblob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    const murl=URL.createObjectURL(mblob);
    const link=document.createElement('link'); link.rel='manifest'; link.href=murl; document.head.appendChild(link);

    if('serviceWorker' in navigator && location.protocol!=='file:'){
      const swCode=`
        const CACHE='period-cache-v1';
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting();});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim());});
        self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        }).catch(()=>r)));});
      `;
      const swBlob=new Blob([swCode],{type:'text/javascript'});
      const swUrl=URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  }catch(e){}
})();

/* ========= åˆå§‹åŒ– ========= */
(async function init(){
  // åˆå§‹è¡¨å•ä½¿ç”¨æœ€è¿‘ä¸€æ¬¡è®°å½•æˆ–é»˜è®¤
  if(DB.cycles.length){
    const last = [...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start)).at(-1);
    $('#startDate').value   = last.start;
    $('#periodLength').value= last.periodLength;
    $('#cycleLength').value = last.cycleLength;
    const d = fromKey(last.start); view.y=d.getFullYear(); view.m=d.getMonth();
  }else{
    $('#periodLength').value = DB.profile.periodLength;
    $('#cycleLength').value  = DB.profile.cycleLength;
  }
  await checkLock();
  renderCalendar();
})();
</script>
</body>
</html>