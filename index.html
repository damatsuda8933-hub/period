<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>经期记录</title>
<style>
  :root{
    --bg:#eef9f1; --card:#ffffff; --ink:#1b4332; --muted:#5c7a6b; --line:#cce3d5;
    /* 四期颜色：更浅更淡 */
    --pink:#ffe4ec;   /* 经期 */
    --mint:#eaffe6;   /* 卵泡期 */
    --blue:#def7ff;   /* 排卵高峰（3天）*/
    --gold:#fff6d8;   /* 黄体期 */
    --today:#1b4332;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Noto Sans SC",sans-serif}
  .wrap{max-width:820px;margin:20px auto;padding:0 16px 36px}
  h1{font-size:20px;margin:14px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select,textarea{
    padding:8px 12px;border:1px solid var(--line);border-radius:14px;background:var(--card)
  }
  button.primary{background:#2d6a4f;color:#fff;border-color:#2d6a4f}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
  .muted{color:var(--muted);font-size:14px}

  /* 工具栏两行布局 */
  .toolbar{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  .topbar .nav{display:flex;gap:8px}
  .secondbar{display:flex;gap:8px}
  .month{font-weight:600;color:#2e4b3f}

  /* 图例（四项对齐） */
  .legend{display:block}
  .legend-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .legend-item{display:flex;align-items:center;gap:8px;min-height:28px}
  .legend .sw{display:inline-block;width:16px;height:14px;border-radius:4px;border:1px solid var(--line)}
  .sw.p{background:var(--pink)} .sw.f{background:var(--mint)} .sw.o{background:var(--blue)} .sw.l{background:var(--gold)}

  /* 日历 */
  .cal{width:100%;border-collapse:collapse;margin-top:8px}
  .cal th,.cal td{border:1px solid var(--line);width:14.285%;vertical-align:top;text-align:center}
  .cal th{background:#f4fbf7;padding:8px 0;font-weight:600}
  .cal td{height:86px;position:relative;background:#fff;cursor:pointer}
  .cal td.p{background:var(--pink)} .cal td.f{background:var(--mint)}
  .cal td.o{background:var(--blue)} .cal td.l{background:var(--gold)}
  .cal td .d{position:absolute;top:6px;left:6px;font-size:12px;color:#2c3e50}
  .cal td.today{outline:2px dashed var(--today);outline-offset:-4px}
  /* 月相强度：给单元格加深一层遮罩（🌑=无；🌒/🌗/🌕 逐级加深） */
  .cal td[data-moon="2"]::after,
  .cal td[data-moon="3"]::after,
  .cal td[data-moon="4"]::after{
    content:"";position:absolute;inset:0;border-radius:0;pointer-events:none;
  }
  .cal td[data-moon="2"]::after{background:rgba(0,0,0,0.06)}
  .cal td[data-moon="3"]::after{background:rgba(0,0,0,0.12)}
  .cal td[data-moon="4"]::after{background:rgba(0,0,0,0.20)}
  /* 只保留心情 emoji，放右下角，留白更足 */
  .note{position:absolute;bottom:6px;right:6px;font-size:20px;line-height:1}

  /* 对话框与图库 */
  dialog{border:none;border-radius:14px;padding:0;max-width:420px;width:92%}
  .dlg{padding:14px}
  .dlg h3{margin:0 0 8px 0;font-size:16px}
  .moon-row{display:flex;gap:6px;flex-wrap:wrap}
  .moon{font-size:22px;line-height:40px;width:40px;height:40px;display:grid;place-items:center;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#fff}
  .moon.sel{outline:2px solid #2d6a4f}
  .footer{margin-top:2px;padding:10px;background:#f6fcf9;border-top:1px solid var(--line);border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .thumb{width:100%;max-height:220px;object-fit:contain;border:1px solid var(--line);border-radius:10px;background:#fff}

  /* 图库 */
  #galleryDlg{max-width:940px}
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:10px}
  .tile{border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .tile img{width:100%;height:140px;object-fit:cover;display:block}
  .tile figcaption{font-size:12px;color:#344;text-align:center;padding:6px 4px;background:#f7fcf9}
  .bbar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--line);background:#f4fbf7;border-top-left-radius:14px;border-top-right-radius:14px}

  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#eef6f0;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .danger{background:#8c2f39;color:#fff;border-color:#8c2f39}

  /* 心情反馈 toast + 彩带 */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(6px);
    background:rgba(0,0,0,.78);color:#fff;padding:10px 14px;border-radius:20px;font-size:14px;
    z-index:9999;opacity:0;transition:opacity .18s, transform .18s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .confetti{position:fixed;inset:0;pointer-events:none;z-index:9998}
  .confetti i{position:absolute;top:-10px;width:8px;height:12px;opacity:.9;animation:fall 1.8s linear forwards}
  @keyframes fall{to{transform:translateY(110vh) rotate(360deg);opacity:.95}}
</style>
</head>
<body>
<div class="wrap" id="app">
  <h1>经期记录</h1>

  <!-- 周期录入 -->
  <div class="card">
    <div class="row">
      <label>本次月经第 1 天 <input type="date" id="startDate"></label>
      <label>经期天数 <input type="number" id="periodLength" value="5" min="1" max="12" style="width:90px"></label>
      <label>平均周期 <input type="number" id="cycleLength" value="28" min="18" max="60" style="width:90px"></label>
      <button class="primary" id="saveCycle">保存/更新此周期</button>
      <button id="setDefaults" title="将当前数值设为默认">设为默认</button>
    </div>
    <div class="muted" style="margin-top:6px">长期保存多个周期；预测使用最近 6 次中位数，仅供参考。</div>
  </div>

  <!-- 工具栏（两行） -->
  <div class="toolbar">
    <div class="topbar">
      <div class="nav">
        <button id="prevM">◀ 上月</button>
        <button id="today">今月</button>
        <button id="nextM">下月 ▶</button>
      </div>
      <div class="month" id="monthLabel"></div>
    </div>
    <div class="secondbar">
      <button id="openGallery">打开图库</button>
      <button id="openYear">年度总结</button>
    </div>
  </div>

  <!-- 图例（四项对齐） -->
  <div class="legend card">
    <div class="legend-grid">
      <div class="legend-item"><span class="sw p"></span><span>经期</span></div>
      <div class="legend-item"><span class="sw f"></span><span>卵泡期</span></div>
      <div class="legend-item"><span class="sw o"></span><span>排卵高峰（3 天）</span></div>
      <div class="legend-item"><span class="sw l"></span><span>黄体期</span></div>
    </div>
  </div>

  <!-- 日历 -->
  <div class="card" id="calendarCard"><table class="cal" id="cal"></table></div>

  <!-- 摘要（含同比上月） -->
  <div class="card" id="summary"></div>

  <!-- 设置/备份 -->
  <div class="card">
    <div class="row" style="flex-wrap:wrap">
      <button id="exportBtn">导出备份</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="importBtn">导入备份</button>
      <button id="icsBtn">导出 .ics（下次预测）</button>
      <button id="setPIN">设置/修改 PIN</button>
      <button id="clearPIN">关闭 PIN</button>
      <button class="danger" id="wipeAll">一键清空</button>
    </div>
    <div class="muted" style="margin-top:6px">图片存 IndexedDB（含上传时间）；导出备份包含图片与时间戳。</div>
  </div>
</div>

<!-- 编辑对话框 -->
<dialog id="editor">
  <div class="dlg">
    <h3 id="dlgTitle">编辑</h3>
    <div class="row" style="margin:6px 0 6px 0">
      <label>心情 <input id="moodInput" placeholder="🙂 / 😴 / 😠 ..." style="width:160px"></label>
      <label>阶段覆盖
        <select id="phaseOverride">
          <option value="">自动</option><option value="p">经期</option><option value="f">卵泡期</option>
          <option value="o">排卵高峰</option><option value="l">黄体期</option>
        </select>
      </label>
    </div>
    <div>
      <div class="muted" style="margin-bottom:4px">月相强度</div>
      <div class="moon-row" id="moonRow">
        <div class="moon" data-v="1" title="无">🌑</div>
        <div class="moon" data-v="2" title="轻">🌒</div>
        <div class="moon" data-v="3" title="中">🌗</div>
        <div class="moon" data-v="4" title="高">🌕</div>
      </div>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:4px">肌肤记录（文本）</div>
      <textarea id="skinText" rows="3" placeholder="如：今日泛红减轻，屏障感较稳…" style="width:100%"></textarea>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:4px">肌肤照片（可选，自动压缩）</div>
      <input type="file" id="skinImg" accept="image/*">
      <img id="preview" class="thumb" style="display:none;margin-top:8px">
    </div>
  </div>
  <div class="footer">
    <div class="row" style="justify-content:space-between">
      <button id="delImg">删除图片</button>
      <div>
        <button id="delNote">清除记录</button>
        <button class="primary" id="saveNote">保存</button>
      </div>
    </div>
  </div>
</dialog>

<!-- 图库 -->
<dialog id="galleryDlg">
  <div class="bbar">
    <strong>📷 图库</strong>
    <div class="row">
      <select id="galleryYear"></select>
      <button id="closeGal">关闭</button>
    </div>
  </div>
  <div class="gallery" id="galleryGrid"></div>
</dialog>

<!-- 年度总结 -->
<dialog id="yearDlg">
  <div class="bbar">
    <strong>📈 年度总结</strong>
    <div class="row">
      <select id="yearSel"></select>
      <button id="closeYear">关闭</button>
    </div>
  </div>
  <div class="dlg" id="yearBody"></div>
</dialog>

<!-- 锁屏 -->
<dialog id="lock">
  <div class="dlg">
    <h3 style="margin-bottom:10px">已加锁</h3>
    <div class="row">
      <input type="password" id="pinInput" inputmode="numeric" placeholder="输入 PIN（4–12位）" style="width:220px">
      <button class="primary" id="unlockBtn">解锁</button>
    </div>
    <div id="lockMsg" class="muted" style="margin-top:6px"></div>
  </div>
</dialog>

<script>
/* ===== 工具：日期 ===== */
const pad = n => String(n).padStart(2,'0');
const dateKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const fromKey = k => { const [y,m,d]=k.split('-').map(Number); return new Date(y, m-1, d, 12); };
const addDays = (d,n) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+n, 12);
const diffDays = (a,b) => Math.round((+new Date(a.getFullYear(),a.getMonth(),a.getDate(),12) - +new Date(b.getFullYear(),b.getMonth(),b.getDate(),12))/86400000);
const isBetween = (d,a,b) => diffDays(d,a) >= 0 && diffDays(d,b) <= 0;
const $ = s => document.querySelector(s);

/* ===== 数据（localStorage + IndexedDB） ===== */
const DB_KEY = 'periodDB_v5';
const loadDB = () => {
  try{ return JSON.parse(localStorage.getItem(DB_KEY)) || {
    profile:{periodLength:5, cycleLength:28},
    cycles:[],
    notes:{}  // "YYYY-MM-DD": { mood:"🙂", moon:1..4, skinText:"", phase?:'p'|'f'|'o'|'l', hasImg?:true }
  }; }catch(e){ return {profile:{periodLength:5,cycleLength:28},cycles:[],notes:{}}; }
};
const saveDB = db => localStorage.setItem(DB_KEY, JSON.stringify(db));
let DB = loadDB();

/* ---- IndexedDB（保存 dataURL + 上传时间） ---- */
const IDB_NAME='periodMedia_v2', STORE='images';
function idbOpen(){ return new Promise((res,rej)=>{ const r = indexedDB.open(IDB_NAME,1);
  r.onupgradeneeded = ()=> r.result.createObjectStore(STORE,{keyPath:'date'});
  r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function idbGet(date){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE);
  const g=st.get(date); g.onsuccess=()=>res(g.result||null); g.onerror=()=>rej(g.error); }); }
async function idbSet(date, dataURL, updated=null){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE);
  const p=st.put({date,dataURL,updated: updated||Date.now()}); p.onsuccess=()=>res(); p.onerror=()=>rej(p.error); }); }
async function idbDel(date){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE);
  const d=st.delete(date); d.onsuccess=()=>res(); d.onerror=()=>rej(d.error); }); }
async function idbAll(){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE);
  const out={}; st.openCursor().onsuccess=e=>{ const c=e.target.result; if(c){ out[c.key]={dataURL:c.value.dataURL,updated:c.value.updated}; c.continue(); }else res(out); };
  tx.onerror=()=>rej(tx.error); }); }
async function idbClear(){ const db=await idbOpen(); return new Promise((res,rej)=>{
  const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE);
  const c=st.clear(); c.onsuccess=()=>res(); c.onerror=()=>rej(c.error); }); }

/* ===== 视图状态 ===== */
let view = (()=>{ const t=new Date(); return { y:t.getFullYear(), m:t.getMonth() }; })();

/* ===== 周期与阶段 ===== */
function median(a){ if(!a.length) return null; const b=[...a].sort((x,y)=>x-y); const m=Math.floor(b.length/2); return b.length%2? b[m] : Math.round((b[m-1]+b[m])/2); }
function recentMedianCycle(len=6){
  const list=[...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start)).slice(-len);
  const cs=list.map(x=>Number(x.cycleLength)||28), ps=list.map(x=>Number(x.periodLength)||5);
  return {cMed: median(cs)||28, pMed: median(ps)||5};
}
function getCycleForDate(date){
  if(DB.cycles.length===0) return null;
  const list=[...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start));
  const dk=dateKey(date); let base=null;
  for(const c of list){ if(c.start<=dk) base=c; else break; }
  if(!base) return null;
  const cLen=Number(base.cycleLength)||Number(DB.profile.cycleLength)||28;
  const pLen=Number(base.periodLength)||Number(DB.profile.periodLength)||5;
  let s=fromKey(base.start);
  if(diffDays(date,s)>=cLen){ const k=Math.floor(diffDays(date,s)/cLen); s=addDays(s,k*cLen); }
  return {start:s,pLen,cLen};
}
function phaseWindows(start,pLen,cLen){
  const mStart=start, mEnd=addDays(start,pLen-1);
  const oStart=addDays(start,cLen-14-1), oEnd=addDays(start,cLen-14+1);
  const lStart=addDays(start,cLen-14+2), lEnd=addDays(start,cLen-1);
  const fStart=addDays(mEnd,1), fEnd=addDays(oStart,-1);
  return {mStart,mEnd,fStart,fEnd,oStart,oEnd,lStart,lEnd};
}
function getPhaseForDate(date){
  const k=dateKey(date); const ov=DB.notes[k]?.phase; if(ov) return ov;
  const cy=getCycleForDate(date); if(!cy) return '';
  const W=phaseWindows(cy.start,cy.pLen,cy.cLen);
  if(isBetween(date,W.mStart,W.mEnd)) return 'p';
  if(isBetween(date,W.fStart,W.fEnd)) return 'f';
  if(isBetween(date,W.oStart,W.oEnd)) return 'o';
  if(isBetween(date,W.lStart,W.lEnd)) return 'l';
  return '';
}
function skinFavorLabel(phase){
  return phase==='f'?'利于恢复':phase==='o'?'平衡观察':phase==='l'?'易波动':phase==='p'?'敏感':'—';
}

/* ===== 渲染日历 ===== */
const cal=$('#cal'), monthLabel=$('#monthLabel');
function renderCalendar(){
  const y=view.y, m=view.m;
  const first=new Date(y,m,1,12), last=new Date(y,m+1,0,12);
  monthLabel.textContent=`${y} 年 ${m+1} 月`;
  cal.innerHTML='';
  const header=document.createElement('tr');
  '日一二三四五六'.split('').forEach(w=>{ const th=document.createElement('th'); th.textContent=w; header.appendChild(th); });
  cal.appendChild(header);

  let tr=document.createElement('tr');
  for(let i=0;i<first.getDay();i++) tr.appendChild(document.createElement('td'));

  for(let d=1; d<=last.getDate(); d++){
    const cur=new Date(y,m,d,12), k=dateKey(cur), td=document.createElement('td');
    const dd=document.createElement('div'); dd.className='d'; dd.textContent=d; td.appendChild(dd);
    const ph=getPhaseForDate(cur); if(ph) td.classList.add(ph);
    if(k===dateKey(new Date())) td.classList.add('today');
    /* 月相强度→色块浓度 */
    const moonLevel=DB.notes[k]?.moon||1; if(moonLevel>1) td.setAttribute('data-moon',String(moonLevel));
    /* 仅显示“心情 emoji”在右下角 */
    const mood=DB.notes[k]?.mood||''; if(mood){ const box=document.createElement('div'); box.className='note'; box.textContent=mood; td.appendChild(box); }
    td.dataset.date=k; td.addEventListener('click',()=>openEditor(k,ph));
    tr.appendChild(td); if(cur.getDay()===6||d===last.getDate()){ cal.appendChild(tr); tr=document.createElement('tr'); }
  }
  renderSummary();
}

/* ===== 摘要：含上月趋势 & 预测 ===== */
function monthStats(y,m){
  const last=new Date(y,m+1,0,12); const moodCnt={}, moons=[], days=last.getDate();
  for(let d=1; d<=days; d++){
    const k=dateKey(new Date(y,m,d,12)); const nt=DB.notes[k];
    if(nt){ if(nt.mood) moodCnt[nt.mood]=(moodCnt[nt.mood]||0)+1; if(nt.moon) moons.push(nt.moon); }
  }
  const topMood=Object.entries(moodCnt).sort((a,b)=>b[1]-a[1])[0]?.[0]||'—';
  const avgMoon=moons.length? (moons.reduce((a,b)=>a+b,0)/moons.length).toFixed(2) : '—';
  return {topMood, avgMoon, recDays:moons.length};
}
function nextPredictedStart(){
  if(!DB.cycles.length) return null;
  const {cMed,pMed}=recentMedianCycle();
  const list=[...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start));
  let t=fromKey(list.at(-1).start); const today=new Date();
  while(diffDays(t,today)<=0){ t=addDays(t,cMed); }
  return {start:t,cLen:cMed,pLen:pMed};
}
function renderSummary(){
  const mid=new Date(view.y,view.m,15,12), s=$('#summary');
  if(DB.cycles.length===0){ s.innerHTML=`<b>摘要</b><br><span class="muted">尚无周期记录，请先保存一次“本次月经第 1 天”。</span>`; return; }
  const cy=getCycleForDate(mid); if(!cy){ s.innerHTML=`<b>摘要</b><br><span class="muted">此月份早于首个记录，向后翻月或添加更早记录。</span>`; return; }
  const W=phaseWindows(cy.start,cy.pLen,cy.cLen);
  const np=nextPredictedStart(); const nextPred=np?dateKey(np.start):'—';

  /* 趋势：与上月比 */
  const cur=monthStats(view.y,view.m);
  let py=view.y, pm=view.m-1; if(pm<0){pm=11;py--;}
  const prev=monthStats(py,pm);
  const diffMoon=(cur.avgMoon==='—'||prev.avgMoon==='—')?'—':(parseFloat(cur.avgMoon)-parseFloat(prev.avgMoon));
  const moonTrend = diffMoon==='—'?'—':(diffMoon>0?`↗︎ +${diffMoon.toFixed(2)}`:diffMoon<0?`↘︎ ${diffMoon.toFixed(2)}`:'→ 0');
  const recTrend = (cur.recDays-prev.recDays)>0?`↗︎ +${cur.recDays-prev.recDays}`:(cur.recDays-prev.recDays)<0?`↘︎ ${cur.recDays-prev.recDays}`:'→ 0';

  s.innerHTML = `
    <b>摘要（以本月中旬所在的周期为基准）</b><br>
    经期：${dateKey(W.mStart)} — ${dateKey(W.mEnd)}（${cy.pLen} 天）<br>
    卵泡期：${dateKey(W.fStart)} — ${dateKey(W.fEnd)}（利于恢复）<br>
    排卵高峰：${dateKey(W.oStart)} — ${dateKey(W.oEnd)}（平衡观察）<br>
    黄体期：${dateKey(W.lStart)} — ${dateKey(W.lEnd)}（易波动）<br>
    预测下一次经期：<span class="kbd">${nextPred}</span><br><br>
    <b>本月 vs 上月</b><br>
    月相平均等级：${cur.avgMoon}（上月 ${prev.avgMoon}） ${moonTrend}<br>
    有记录天数：${cur.recDays}（上月 ${prev.recDays}） ${recTrend}<br>
    本月最常用心情：${cur.topMood}；上月：${prev.topMood}
  `;
}

/* ===== 编辑器（与图片压缩） ===== */
const editor=$('#editor'); let editKey=null, pendingImg=null;
function openEditor(k,phase){
  editKey=k; pendingImg=null;
  $('#dlgTitle').textContent=`编辑 ${k}（${skinFavorLabel(phase)}）`;
  $('#moodInput').value=DB.notes[k]?.mood||'';
  $('#skinText').value=DB.notes[k]?.skinText||'';
  $('#phaseOverride').value=DB.notes[k]?.phase||'';
  const level=DB.notes[k]?.moon||1;
  document.querySelectorAll('.moon').forEach(el=>{
    el.classList.toggle('sel', Number(el.dataset.v)===level);
    el.onclick=()=>{ document.querySelectorAll('.moon').forEach(x=>x.classList.remove('sel')); el.classList.add('sel'); editor.dataset.moon=el.dataset.v; };
  });
  editor.dataset.moon=String(level||1);
  // 预览图片
  $('#skinImg').value='';
  idbGet(k).then(rec=>{
    const prev=$('#preview'); if(rec){ prev.src=rec.dataURL; prev.style.display='block'; } else { prev.removeAttribute('src'); prev.style.display='none'; }
    editor.showModal();
  });
}
function compressImage(file){ return new Promise((resolve,reject)=>{
  const fr=new FileReader(); fr.onload=()=>{
    const img=new Image(); img.onload=()=>{
      const max=1280; let w=img.width,h=img.height; const r=Math.min(1,max/Math.max(w,h));
      const cw=Math.round(w*r), ch=Math.round(h*r);
      const cv=document.createElement('canvas'); cv.width=cw; cv.height=ch;
      const ctx=cv.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
      let url; try{ url=cv.toDataURL('image/jpeg',0.82); }catch{ url=cv.toDataURL('image/png'); }
      resolve(url);
    }; img.onerror=reject; img.src=fr.result;
  }; fr.onerror=reject; fr.readAsDataURL(file);
});}
$('#skinImg').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const url=await compressImage(f); pendingImg=url;
  const prev=$('#preview'); prev.src=url; prev.style.display='block';
});
$('#delImg').onclick=async ()=>{ if(!editKey) return; await idbDel(editKey); pendingImg=null; if(DB.notes[editKey]) DB.notes[editKey].hasImg=false; saveDB(DB);
  const prev=$('#preview'); prev.removeAttribute('src'); prev.style.display='none'; };
$('#saveNote').onclick=async ()=>{
  if(!editKey){ editor.close(); return; }
  const mood=$('#moodInput').value.trim();
  const moon=Number(editor.dataset.moon||1);
  const skinText=$('#skinText').value.trim();
  const phase=$('#phaseOverride').value;
  DB.notes[editKey]={...(DB.notes[editKey]||{}), mood, moon, skinText};
  if(phase) DB.notes[editKey].phase=phase; else delete DB.notes[editKey].phase;
  if(pendingImg){ await idbSet(editKey, pendingImg); DB.notes[editKey].hasImg=true; }
  const n=DB.notes[editKey]; if(!n.mood && !n.moon && !n.skinText && !n.hasImg && !n.phase) delete DB.notes[editKey];
  saveDB(DB);
  editor.close();
  renderCalendar();
  if(mood) reactToMood(mood);   // 保存后根据心情弹出留言/特效
};
$('#delNote').onclick=async ()=>{ if(editKey&&DB.notes[editKey]) delete DB.notes[editKey]; await idbDel(editKey); saveDB(DB); editor.close(); renderCalendar(); };

/* ===== 周期录入/导航 ===== */
$('#saveCycle').onclick=()=>{ const s=$('#startDate').value; if(!s) return alert('请选择“本次月经第 1 天”。');
  const p=Number($('#periodLength').value)||5, c=Number($('#cycleLength').value)||28;
  const i=DB.cycles.findIndex(x=>x.start===s); if(i>=0) DB.cycles[i]={start:s,periodLength:p,cycleLength:c}; else DB.cycles.push({start:s,periodLength:p,cycleLength:c});
  const d=fromKey(s); view.y=d.getFullYear(); view.m=d.getMonth(); saveDB(DB); renderCalendar(); };
$('#setDefaults').onclick=()=>{ DB.profile.periodLength=Number($('#periodLength').value)||5; DB.profile.cycleLength=Number($('#cycleLength').value)||28; saveDB(DB); alert('已设为默认。'); };
$('#prevM').onclick=()=>{ view.m--; if(view.m<0){view.m=11;view.y--;} renderCalendar(); };
$('#nextM').onclick=()=>{ view.m++; if(view.m>11){view.m=0;view.y++;} renderCalendar(); };
$('#today').onclick =()=>{ const t=new Date(); view.y=t.getFullYear(); view.m=t.getMonth(); renderCalendar(); };

/* ===== 备份 / 导入 / .ics / 清空 ===== */
$('#exportBtn').onclick=async ()=>{ const images=await idbAll(); const payload={version:2, db:DB, images};
  const blob=new Blob([JSON.stringify(payload)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='period-backup.json'; a.click(); URL.revokeObjectURL(a.href); };
$('#importBtn').onclick=()=>$('#importFile').click();
$('#importFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader();
  r.onload=async ()=>{ try{
      const obj=JSON.parse(r.result); DB = obj.db || obj; saveDB(DB);
      if(obj.images){ for(const [k,v] of Object.entries(obj.images)){ const rec=typeof v==='string'?{dataURL:v}:v; await idbSet(k, rec.dataURL, rec.updated||Date.now()); if(DB.notes[k]) DB.notes[k].hasImg=true; } saveDB(DB); }
      location.reload();
    }catch{ alert('文件格式不对'); } };
  r.readAsText(f);
};
function icsDate(key){ const [y,m,d]=key.split('-').map(Number); return `${y}${pad(m)}${pad(d)}`; }
$('#icsBtn').onclick=()=>{ const np=nextPredictedStart(); if(!np) return alert('还没有足够数据用于预测。');
  const sKey=dateKey(np.start), eKey=dateKey(addDays(np.start,np.pLen));
  const ovCenter=addDays(np.start,-14), osKey=dateKey(addDays(ovCenter,-1)), oeKeyEx=dateKey(addDays(ovCenter,2));
  const uid=()=>'xxxxxx'.replace(/x/g,()=>Math.floor(Math.random()*16).toString(16))+Date.now();
  const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//period-local//cn//','CALSCALE:GREGORIAN','METHOD:PUBLISH',
    'BEGIN:VEVENT',`UID:${uid()}`,'SUMMARY:经期（预测）',`DTSTART;VALUE=DATE:${icsDate(sKey)}`,`DTEND;VALUE=DATE:${icsDate(eKey)}`,'END:VEVENT',
    'BEGIN:VEVENT',`UID:${uid()}`,'SUMMARY:排卵高峰（预测）',`DTSTART;VALUE=DATE:${icsDate(osKey)}`,`DTEND;VALUE=DATE:${icsDate(oeKeyEx)}`,'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const blob=new Blob([ics],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='period-prediction.ics'; a.click(); URL.revokeObjectURL(a.href); };
$('#wipeAll').onclick=async ()=>{ if(!confirm('确定清空所有数据？此操作不可撤销。')) return; localStorage.removeItem(DB_KEY); await idbClear(); location.reload(); };

/* ===== PIN 加锁（Promise 版，便于等待解锁后再提示） ===== */
async function sha256(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(x=>x.toString(16).padStart(2,'0')).join(''); }
function getPIN(){ try{return JSON.parse(localStorage.getItem('periodPIN')||'null');}catch{return null;} }
function setPINHash(hash){ localStorage.setItem('periodPIN', JSON.stringify({hash})); }
function clearPIN(){ localStorage.removeItem('periodPIN'); }
$('#setPIN').onclick=async ()=>{ const p=prompt('设置/修改 PIN（4–12位，留空取消）'); if(!p) return; if(p.length<4||p.length>12) return alert('长度应在 4–12 位。'); const h=await sha256(p); setPINHash(h); alert('已设置 PIN。'); };
$('#clearPIN').onclick=()=>{ clearPIN(); alert('已关闭 PIN。'); };
function waitUnlock(){
  return new Promise(resolve=>{
    const pin=getPIN(); if(!pin){ resolve(); return; }
    const lock=$('#lock'); lock.showModal(); $('#pinInput').value=''; $('#lockMsg').textContent='';
    $('#unlockBtn').onclick=async ()=>{ const h=await sha256($('#pinInput').value||''); if(h===pin.hash){ lock.close(); resolve(); } else { $('#lockMsg').textContent='PIN 错误'; } };
  });
}

/* ===== 心情识别 & 留言/特效 ===== */
const MOOD_REGEX = {
  happy: /[😀😃😄😁😆😊🙂😍🥰😘🤩🥳😺😸😹✨🎉👍❤️💖]/u,
  sad:   /[😢😭🥲😞😔☹️🙁🥺😿💧]/u,
  sick:  /[🤧🤒🤢🤮🤕😷🥴]/u,
  angry: /[😠😡🤬👿💢]/u,
  anxious:/[😰😥😓😱😨😟😬]/u,
  tired: /[😪😴🥱]/u
};
function classifyMood(text){
  if(!text) return 'neutral';
  if(MOOD_REGEX.happy.test(text)) return 'happy';
  if(MOOD_REGEX.sad.test(text))   return 'sad';
  if(MOOD_REGEX.sick.test(text))  return 'sick';
  if(MOOD_REGEX.angry.test(text)) return 'angry';
  if(MOOD_REGEX.anxious.test(text)) return 'anxious';
  if(MOOD_REGEX.tired.test(text)) return 'tired';
  return 'neutral';
}
const MOOD_LINES = {
  happy:  ['耶！今天好闪亮～保持这份好心情 ✨','小确幸记录成功，给你一朵大花🌼','把快乐存进电池里啦🔋'],
  sad:    ['抱抱你～难过会过去，我在这儿🤍','对自己温柔一点，慢慢来就好🌙','允许自己休息一下，好吗？☁️'],
  sick:   ['多喝水多休息，早点好起来🍵','今天轻量模式，照顾自己最重要🫂','记得保暖与早睡～🌿'],
  angry:  ['先深呼吸三次，我们一起放下不快🌬️','你的感受被看见了，我懂🙌','允许情绪来去，别为难自己💚'],
  anxious:['试试 4-7-8 呼吸法，放松一下🌊','把担心写下来，交给明天处理📄','现在专注眼前一分钟就好⌛'],
  tired:  ['辛苦了，睡一觉会更好😴','补点能量再出发🍫','今天给自己多一点耐心～🫶'],
  neutral:['继续记录，未来的你会感谢现在📘','稳稳的一天，做得好～','保持节奏，慢慢变好🌱']
};
function randLine(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function showToast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2200);
}
function confettiBurst(){
  const colors=['#76d7c4','#f7dc6f','#ff8ba7','#7fb3d5','#82e0aa'];
  const wrap=document.createElement('div'); wrap.className='confetti'; document.body.appendChild(wrap);
  for(let i=0;i<36;i++){
    const p=document.createElement('i');
    p.style.left=Math.random()*100+'vw';
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.transform=`translateY(0) rotate(${Math.random()*360}deg)`;
    p.style.animationDuration=(1.3+Math.random()*1.2)+'s';
    p.style.width=(6+Math.random()*6)+'px';
    p.style.height=(8+Math.random()*10)+'px';
    wrap.appendChild(p);
  }
  setTimeout(()=>wrap.remove(), 2000);
}
function reactToMood(moodText){
  const tag = classifyMood(moodText);
  showToast(randLine(MOOD_LINES[tag]));
  if(tag==='happy') confettiBurst();
}

/* 每日随机留言：一天一次。优先依据“今天/昨天”的心情，没有就 neutral */
function dailyHello(){
  const key = dateKey(new Date());
  let last = null; try{ last = JSON.parse(localStorage.getItem('periodDailyMsg_v1')||'null'); }catch{}
  if(last && last.date === key) return; // 今天已经弹过
  const todayMood = DB.notes[key]?.mood || '';
  const yMood = DB.notes[dateKey(addDays(new Date(), -1))]?.mood || '';
  const baseMood = todayMood || yMood || '';
  reactToMood(baseMood);
  localStorage.setItem('periodDailyMsg_v1', JSON.stringify({date:key}));
}

/* ===== 图库 ===== */
const galDlg=$('#galleryDlg'), galGrid=$('#galleryGrid'), galYear=$('#galleryYear');
function yearsWithImages(list){ const ys=[...new Set(list.map(([k])=>k.slice(0,4)))]; return ys.sort((a,b)=>b.localeCompare(a)); }
async function openGallery(){
  const all=await idbAll(); const entries=Object.entries(all); if(entries.length===0){ galGrid.innerHTML='<div class="dlg">暂无照片</div>'; galDlg.showModal(); return; }
  const ys=yearsWithImages(entries); galYear.innerHTML=ys.map(y=>`<option>${y}</option>`).join('');
  const curY=galYear.value=galYear.value||ys[0];
  renderGalleryYear(curY, entries);
  galDlg.showModal();
}
function renderGalleryYear(y, entries){
  const sel=entries.filter(([k])=>k.startsWith(y+'-')).sort((a,b)=>b[0].localeCompare(a[0]));
  galGrid.innerHTML = sel.map(([k,v])=>{
    const up = v.updated ? new Date(v.updated) : null;
    const upStr = up ? `${up.getFullYear()}-${pad(up.getMonth()+1)}-${pad(up.getDate())} ${pad(up.getHours())}:${pad(up.getMinutes())}` : '';
    return `<figure class="tile" data-date="${k}">
      <img src="${v.dataURL}" alt="${k}">
      <figcaption>${k}${upStr?` · 上传 ${upStr}`:''}</figcaption>
    </figure>`;
  }).join('');
  galGrid.querySelectorAll('.tile').forEach(fig=>{
    fig.onclick=async ()=>{ const k=fig.dataset.date; const rec=await idbGet(k);
      const dlg=document.createElement('dialog'); dlg.style.maxWidth='96%'; dlg.innerHTML=`
        <div class="bbar"><strong>${k}</strong><button id="x">关闭</button></div>
        <div class="dlg"><img class="thumb" style="max-height:70vh" src="${rec.dataURL}"></div>`;
      document.body.appendChild(dlg); dlg.showModal(); dlg.querySelector('#x').onclick=()=>{dlg.close(); dlg.remove();};
    };
  });
}
$('#openGallery').onclick = openGallery;
$('#closeGal').onclick = ()=> galDlg.close();
galYear.onchange = async ()=>{ const all=await idbAll(); renderGalleryYear(galYear.value, Object.entries(all)); };

/* ===== 年度总结 ===== */
const yearDlg=$('#yearDlg'), yearSel=$('#yearSel'), yearBody=$('#yearBody');
function listYearsFromNotes(){ const ks=Object.keys(DB.notes); const ys=[...new Set(ks.map(k=>k.slice(0,4)))].filter(Boolean); if(ys.length===0){ ys.push(String(new Date().getFullYear())); } return ys.sort((a,b)=>b.localeCompare(a)); }
function monthStatsForYear(y,m){
  const last=new Date(y,m+1,0,12); const moodCnt={}, moons=[], days=last.getDate();
  for(let d=1; d<=days; d++){ const k=dateKey(new Date(y,m,d,12)); const nt=DB.notes[k]; if(nt){ if(nt.moon) moons.push(nt.moon); if(nt.mood) moodCnt[nt.mood]=(moodCnt[nt.mood]||0)+1; } }
  const avgMoon=moons.length? (moons.reduce((a,b)=>a+b,0)/moons.length).toFixed(2) : '—';
  const topMood=Object.entries(moodCnt).sort((a,b)=>b[1]-a[1])[0]?.[0]||'—';
  return {avgMoon, topMood, days:moons.length};
}
function monthSummaryRow(y,m){ const st=monthStatsForYear(y,m); return `<tr><td>${m+1}</td><td>${st.avgMoon}</td><td>${st.days}</td><td>${st.topMood}</td></tr>`; }
function openYear(){
  const ys=listYearsFromNotes(); yearSel.innerHTML=ys.map(y=>`<option>${y}</option>`).join(''); yearSel.value=yearSel.value||ys[0]; renderYear(+yearSel.value); yearDlg.showModal();
}
function renderYear(Y){
  let rows=''; for(let m=0;m<12;m++) rows+=monthSummaryRow(Y,m);
  // 年度汇总
  let moonVals=[], recTotal=0, moodAll={};
  for(let m=0;m<12;m++){
    const last=new Date(Y,m+1,0,12);
    for(let d=1; d<=last.getDate(); d++){
      const k=dateKey(new Date(Y,m,d,12)); const nt=DB.notes[k];
      if(nt){ if(nt.moon) moonVals.push(nt.moon); if(nt.mood) moodAll[nt.mood]=(moodAll[nt.mood]||0)+1; if(nt.moon) recTotal++; }
    }
  }
  const yearAvg = moonVals.length ? (moonVals.reduce((a,b)=>a+b,0)/moonVals.length).toFixed(2) : '—';
  const topMood = Object.entries(moodAll).sort((a,b)=>b[1]-a[1])[0]?.[0] || '—';
  yearBody.innerHTML = `
    <div class="dlg">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th>月</th><th>月相平均等级</th><th>有记录天数</th><th>最常用心情</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="margin-top:10px">全年平均月相等级：<b>${yearAvg}</b>；全年最常用心情：<b>${topMood}</b>；全年记录天数：<b>${recTotal}</b></div>
    </div>`;
}
$('#openYear').onclick=openYear; $('#closeYear').onclick=()=>yearDlg.close(); yearSel.onchange=()=>renderYear(+yearSel.value);

/* ===== PWA（在 GitHub Pages 上可用；file:// 模式会忽略） ===== */
(function setupPWA(){
  try{
    // 生成一个简单图标
    const cv=document.createElement('canvas'); cv.width=192; cv.height=192;
    const ctx=cv.getContext('2d'); ctx.fillStyle='#e9f7ef'; ctx.fillRect(0,0,192,192);
    ctx.fillStyle='#2d6a4f'; ctx.beginPath(); ctx.arc(96,96,58,0,Math.PI*2); ctx.fill();
    const icon=cv.toDataURL('image/png');
    const manifest={ name:'经期记录', short_name:'经期记录', start_url:'./', display:'standalone',
      background_color:'#e9f7ef', theme_color:'#2d6a4f', icons:[{src:icon,sizes:'192x192',type:'image/png'}] };
    const mblob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    const murl=URL.createObjectURL(mblob);
    const link=document.createElement('link'); link.rel='manifest'; link.href=murl; document.head.appendChild(link);

    if('serviceWorker' in navigator && location.protocol!=='file:'){
      const swCode=`
        const CACHE='period-cache-v1';
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting();});
        self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim());});
        self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        }).catch(()=>r)));});
      `;
      const swBlob=new Blob([swCode],{type:'text/javascript'});
      const swUrl=URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(()=>{});
    }
  }catch(e){}
})();

/* ===== 初始化 ===== */
(async function init(){
  if(DB.cycles.length){
    const last=[...DB.cycles].sort((a,b)=>a.start.localeCompare(b.start)).at(-1);
    $('#startDate').value=last.start; $('#periodLength').value=last.periodLength; $('#cycleLength').value=last.cycleLength;
    const d=fromKey(last.start); view.y=d.getFullYear(); view.m=d.getMonth();
  }else{
    $('#periodLength').value=DB.profile.periodLength; $('#cycleLength').value=DB.profile.cycleLength;
  }
  await waitUnlock();       // 解锁后再继续
  renderCalendar();
  dailyHello();             // 每日随机留言（一天一次）
})();
</script>
</body>
</html>
